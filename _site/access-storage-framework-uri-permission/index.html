<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Access Storage Framework and the URI permissions nightmare &#8211; Andrea Maglie</title>
<meta name="description" content="A blog by Andrea Maglie.">
<meta name="keywords" content="android">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000/images/android1.png">

<meta name="twitter:title" content="Access Storage Framework and the URI permissions nightmare">
<meta name="twitter:description" content="A blog by Andrea Maglie.">
<meta name="twitter:creator" content="@techisfun">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Access Storage Framework and the URI permissions nightmare">
<meta property="og:description" content="A blog by Andrea Maglie.">
<meta property="og:url" content="http://localhost:4000/access-storage-framework-uri-permission/">
<meta property="og:site_name" content="Andrea Maglie">





<link rel="canonical" href="http://localhost:4000/access-storage-framework-uri-permission/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Andrea Maglie Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- BOOTSTRAP Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">




</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://localhost:4000/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://localhost:4000/images/avatar.png" alt="Andrea Maglie photo" class="author-photo">
					<h4>Andrea Maglie</h4>
					<p>Java Developer - Android Developer & Designer - Tech Enthusiast - Guitar Player - Music Lover</p>
				</li>
				<li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				
				<li>
					<a href="http://twitter.com/techisfun"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				<li>
					<a href="https://google.com/+AndreaMaglie"><i class="fa fa-fw fa-google-plus"></i> Google+</a>
				</li>
				
				<li>
					<a href="http://github.com/techisfun"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://localhost:4000/posts/">All Posts</a></li>
				<li><a href="http://localhost:4000/tags/">All Tags</a></li>
			</ul>
		</li>
		
	    
	        
	    
	    <li><a href="http://localhost:4000/portfolio/" >Portfolio</a></li>
	  
	    
	        
	    
	    <li><a href="http://localhost:4000/curriculum/" >Curriculum Vitae</a></li>
	  
	    
	        
	        
	    <li><a href="http://bit.ly/1bISG1K" target="_blank">Apps On Play Store</a></li>
	  
	    
	        
	    
	    <li><a href="http://localhost:4000/contact-me/" >Contact me</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="http://localhost:4000/images/android1.png" alt="Access Storage Framework and the URI permissions nightmare">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="http://localhost:4000/access-storage-framework-uri-permission/" rel="bookmark" title="Access Storage Framework and the URI permissions nightmare">Access Storage Framework and the URI permissions nightmare</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2015-01-09T00:00:00+01:00">January 09, 2015</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~2 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>I’ve been working with the <strong>Access Storage Framework</strong> introduced with Android KitKat, a feature that I’ve been waiting for a long time.</p>

<p>Everything seemed to be alright, quite easy to implement, until I faced a strange issue.</p>

<p>Once the file has been selected by the user, I wanted to store the file’s URI and re-open that URI the next time application is started. To do this, I’ve followed what the <a href="https://developer.android.com/guide/topics/providers/document-provider.html">official documentation</a> says:</p>

<blockquote>
  <p>When your app opens a file for reading or writing, the system gives your app a URI permission grant for that file. It lasts until the user’s device restarts. But suppose your app is an image-editing app, and you want users to be able to access the last 5 images they edited, directly from your app. If the user’s device has restarted, you’d have to send the user back to the system picker to find the files, which is obviously not ideal.</p>
</blockquote>

<blockquote>
  <p>To prevent this from happening, you can persist the permissions the system gives your app. Effectively, your app “takes” the persistable URI permission grant that the system is offering. This gives the user continued access to the files through your app, even if the device has been restarted:</p>
</blockquote>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kt">int</span> <span class="n">takeFlags</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getFlags</span><span class="o">()</span>
            <span class="o">&amp;</span> <span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span>
            <span class="o">|</span> <span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_WRITE_URI_PERMISSION</span><span class="o">);</span>
<span class="c1">// Check for the freshest data.</span>
<span class="n">getContentResolver</span><span class="o">().</span><span class="na">takePersistableUriPermission</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">takeFlags</span><span class="o">);</span></code></pre></div>

<p>It didn’t work. <em>Doh!</em></p>

<p>I was getting a <code>java.lang.SecurityException</code> while trying to open the URI using <code>getContentResolver().openInputStream(uri)</code> or <code>getContentResolver().openAssetFileDescriptor(uri, "r")</code>:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">SecurityException</span><span class="o">:</span> <span class="n">Permission</span> <span class="nl">Denial:</span> <span class="n">opening</span> <span class="n">provider</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">providers</span><span class="o">.</span><span class="na">media</span><span class="o">.</span><span class="na">MediaDocumentsProvider</span> <span class="n">from</span> <span class="n">ProcessRecord</span><span class="o">{</span><span class="mi">430</span><span class="n">b1748</span> <span class="mi">4572</span><span class="o">:</span><span class="n">com</span><span class="o">.</span><span class="na">x</span><span class="o">.</span><span class="na">x</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">u0a88</span><span class="o">}</span> <span class="o">(</span><span class="n">pid</span><span class="o">=</span><span class="mi">4572</span><span class="o">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">10078</span><span class="o">)</span> <span class="n">requires</span> <span class="n">android</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">MANAGE_DOCUMENTS</span> <span class="n">or</span> <span class="n">android</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">MANAGE_DOCUMENTS</span></code></pre></div>

<p>Adding <code>android.permission.MANAGE_DOCUMENTS</code> to AndroidManifest.xml didn’t helped, and the many solutions found on <em>stackoverflow.com</em> didn’t work.</p>

<p>After taking a deeper look at the APIs and the source code I’ve found a working way to grant URI permissions:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">activity</span><span class="o">.</span><span class="na">grantUriPermission</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(),</span> <span class="n">uri</span><span class="o">,</span> <span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span><span class="o">);</span></code></pre></div>

<p>place this call before <code>getContentResolver().takePersistableUriPermission(uri, takeFlags)</code> and read permissions will be granted! Yeah!</p>

<p>The resulting code will be:</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="n">MY_REQUEST_CODE</span> <span class="o">&amp;&amp;</span> <span class="n">resultCode</span> <span class="o">==</span> <span class="n">Activity</span><span class="o">.</span><span class="na">RESULT_OK</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>

      <span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>

      <span class="n">mActivity</span><span class="o">.</span><span class="na">grantUriPermission</span><span class="o">(</span><span class="n">mActivity</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(),</span> <span class="n">uri</span><span class="o">,</span> <span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span><span class="o">);</span>

      <span class="kd">final</span> <span class="kt">int</span> <span class="n">takeFlags</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getFlags</span><span class="o">()</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_GRANT_READ_URI_PERMISSION</span><span class="o">);</span>
      <span class="n">mActivity</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">().</span><span class="na">takePersistableUriPermission</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">takeFlags</span><span class="o">);</span>

      <span class="n">doSomethingWith</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></div>


      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://localhost:4000/tags/#android" title="Pages tagged android" class="tag"><span class="term">android</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/access-storage-framework-uri-permission/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=http://localhost:4000/access-storage-framework-uri-permission/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=http://localhost:4000/access-storage-framework-uri-permission/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="http://localhost:4000/dont-waste-time-coding-1/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="http://localhost:4000/dont-waste-time-coding-2/" title="Don't waste your time coding - part 2">Don't waste your time coding - part 2</a></h3>
      <p>You can find the first part of this article [here]({{site.baseurl}}/{% post_url 2014-12-16-dont-waste-time-coding-1 %})Automatic code for...&hellip; <a href="http://localhost:4000/dont-waste-time-coding-2/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="http://localhost:4000/dont-waste-time-coding-1/" title="Don't waste your time coding - part 1">Don't waste your time coding - part 1</a></h4>
        <span>Published on December 16, 2014</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="http://localhost:4000/autoincrement-versiocode/" title="Auto-increment versionCode in build.gradle file">Auto-increment versionCode in build.gradle file</a></h4>
        <span>Published on November 04, 2014</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2015 Andrea Maglie. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

<script type="text/javascript" src="http://localhost:4000/assets/js/mandrill.min.js"></script>
<script type="text/javascript" src="http://localhost:4000/assets/js/jqBootstrapValidation.js"></script>
<script type="text/javascript" src="http://localhost:4000/assets/js/contact_me.js"></script>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48681711-2', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

  // click on timeline trigger
  $('.timeline-item-trigger span').each(function() {
	var e = $(this);
	e.click(function () {
		 if (e.hasClass("fa-plus")) {
	      e.removeClass("fa-plus");
	      e.addClass("fa-minus");
	    } else {
	      e.removeClass("fa-minus");
	      e.addClass("fa-plus");
	    }
	});
  });
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'techisfunit'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	        

</body>
</html>
